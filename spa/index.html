<html>
  <head>    
    <title>[ Key ] Codex</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />    
    <link rel="stylesheet" href="index.css"> 
    <script src="index.js"></script>
    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <style>
    body {
      background: whitesmoke;
      display: flex;
      flex-direction: column;
      font-family: Arial;
      height: 100%;
      margin: 0;
      overflow: hidden;
      width: 100%
    }
    
    body[data-theme="dark"] {
      background: #111;
      color: white;
    }
    
    body[data-theme="dark"] textarea {
      color: white;
    }
    
    body > header ico:not([style]) {
      height: 50px;
      width: 50px;
    }
    
    body > header avi {
      border: 1px solid;
      border-radius: 50%;
      box-sizinb: border-box;
      margin-left: auto;
      height: 30px;
      width: 30px;
    }
    
    line.resizer {
      display: flex;
      width: 20px;
    }
    
    @media {
      avi {
        align-items: center;
        display: inline-flex;
        justify-content: center;
      }
      
      ico {
        align-items: center;
        display: inline-flex;
        justify-content: center;
      }
    
      iframe {
        border: 0;
        outline: none;
      }
    
      textarea {
        border: 0;
        outline: 0;
        resize: none;
      }
    
      txt {
        justify-content: center;
      }
    }
    
    editor {
      display: flex;
      flex: 1;
      height: 100%;
      width: 100%;
    }
    
    editor wrap {
      flex: 1;
    }
    
    editor wrap .CodeMirror { 
      height: 100%;
    }
    
    editor iframe {
      background: white;
      flex: 1;
    }
    
    line.resizer {
      background-color: #555;
      height: 100%;
      width: 20px;
    }
    
    body > header {
      align-items: center;
      background: #000;
      display: flex;
      flex-direction: row;
      height: 50px;
    }
    
    .gg-code-slash {
     display: block;
     position: relative;
     box-sizing: border-box;
     transform: rotate(15deg) scale(var(--ggs,1));
     width: 2px;
     height: 16px;
     background: currentColor
    }
    
    .gg-code-slash::after,
    .gg-code-slash::before {
     content: "";
     display: block;
     box-sizing: border-box;
     position: absolute;
     width: 8px;
     height: 8px;
     transform: rotate(-60deg)
    }
    
    .gg-code-slash::before {
     border-left: 2px solid;
     border-top: 2px solid;
     left: -8px;
     top: 5px
    }
    
    .gg-code-slash::after {
     border-right: 2px solid;
     border-bottom: 2px solid;
     right: -8px;
     top: 3px
    }
      </style>
    <style>
      body {
  background: whitesmoke;
  display: flex;
  flex-direction: column;
  font-family: Arial;
  height: 100%;
  margin: 0;
  overflow: hidden;
  width: 100%
}

body[data-theme="dark"] {
  background: #111;
  color: white;
}

body[data-theme="dark"] textarea {
  color: white;
}

body > header ico:not([style]) {
  height: 50px;
  width: 50px;
}

body > header avi {
  border: 1px solid;
  border-radius: 50%;
  box-sizinb: border-box;
  margin-left: auto;
  height: 30px;
  width: 30px;
}

line.resizer {
  display: flex;
  width: 20px;
}

@media {
  avi {
    align-items: center;
    display: inline-flex;
    justify-content: center;
  }
  
  ico {
    align-items: center;
    display: inline-flex;
    justify-content: center;
  }

  iframe {
    border: 0;
    outline: none;
  }

  textarea {
    border: 0;
    outline: 0;
    resize: none;
  }

  txt {
    justify-content: center;
  }
}

editor {
  display: flex;
  flex: 1;
  height: 100%;
  width: 100%;
}

editor wrap {
  flex: 1;
}

editor wrap .CodeMirror { 
  height: 100%;
}

editor iframe {
  background: white;
  flex: 1;
}

line.resizer {
  background-color: #555;
  height: 100%;
  width: 20px;
}

body > header {
  align-items: center;
  background: #000;
  display: flex;
  flex-direction: row;
  height: 50px;
}

.gg-code-slash {
 display: block;
 position: relative;
 box-sizing: border-box;
 transform: rotate(15deg) scale(var(--ggs,1));
 width: 2px;
 height: 16px;
 background: currentColor
}

.gg-code-slash::after,
.gg-code-slash::before {
 content: "";
 display: block;
 box-sizing: border-box;
 position: absolute;
 width: 8px;
 height: 8px;
 transform: rotate(-60deg)
}

.gg-code-slash::before {
 border-left: 2px solid;
 border-top: 2px solid;
 left: -8px;
 top: 5px
}

.gg-code-slash::after {
 border-right: 2px solid;
 border-bottom: 2px solid;
 right: -8px;
 top: 3px
}

      </style>
  </head>
  <body>
    <header>
      <ico>
        <n class="gg-code-slash"></n>
      </ico>
      <txt>
        <span>KeyCode</span>
      </txt>
      <avi>
        <img>
      </avi>
    </header>
    <main>
      <editor>
        <wrap id="editor"></wrap>
        <line class="resizer" id="resizer"></line>
        <iframe id="iframe"></iframe>
      </editor>
    </main>
    <style>
      body {
        font-family:Arial;
        background: #111;
        color: white;
      	margin: 0;
      }
      
      body > header {
        display: flex;
      	align-items: center;
        height: 50px;
        padding: 10px 20px;
      	background: #000
      }
      
      body > header > avi {
        border: 1px solid;
        border-radius: 50%;
        height: 30px;
        margin-left: auto;
        width: 30px;
      }
   </style>
  </head>
  <body>
  <script>
  window.onload = () => {
  
    //document.body.dataset.theme = "system";
    
    //eruda.init();
    
    window.cm = {};
  
    window.dom = {
  
      body: document.body,    
      boot: document.getElementById('boot'),    
      "style": document.getElementById("css"),
      "code":  document.getElementById("editor"),
      "htm": document.getElementById('editor'),
      "html": document.getElementById('html-editor'),
      "css": document.getElementById('css-editor'),
      "js": document.getElementById('js-editor'),
      "resize": {
        "code": document.getElementById("resizer"),
        "html": document.getElementById('html-resizer'),
        "css": document.getElementById('css-resizer'),
        "js": document.getElementById('js-resizer')
      },
  
      "iframe": {
  
        "code": {
  
          "elem": document.getElementById("preview-code")
  
        }
  
      }
  
    };
  
    pvw();
  
    cm.htm = CodeMirror(document.getElementById("editor"), {
  
      lineNumbers: true,
  
      lineWrapping: true,
  
      htmlMode: true,
  
      mode: 'xml',  
  
      styleActiveLine: true,
  
      theme: 'abcdef',
  
      matchBrackets: true
  
    });
  
    cm.htm.on("change",(change) => { 
  
      upd();
  
    });
  
    /*RESIZER*/
  
    let m_pos;
  
    function resize(e) {
  
      const dx = (m_pos - e.x) * -1;
  
      m_pos = e.x;
  
      dom.code.style.width = (parseInt(getComputedStyle(dom.code, '').width) + dx) + "px";
  
      //console.log({m_pos,x:e.x},dx);
  
    }
  
    dom.resize.code.addEventListener("mousedown", function(e){ 
  
      //console.log(e.offsetX);
  
      if (e.offsetX < dom.resize.code.clientWidth) {
  
        m_pos = e.x;
  
        document.body.classList.add('dragging');
  
        document.addEventListener("mousemove", resize, false);
  
      }
  
    }, false);
  
    document.addEventListener("mouseup", function(){
  
      document.body.classList.remove('dragging');
  
      document.removeEventListener("mousemove", resize, false);
  
    }, false); 
  
    /*RESIZER*/
    
    init();
  
  };
  
  function init() {
    console.log('Initialized...');
  }
  
  function getBlobURL(code, type) {
    const blob = new Blob([code], { type });
  
    return URL.createObjectURL(blob);
  }
  
  function getPageURL(html, css, js) {
    const cssURL = getBlobURL(css, "text/css");
  
    const jsURL = getBlobURL(js, "text/javascript");
  
    const source = `
  
      <html>
  
        <head>
  
          ${css && `<link rel="stylesheet" type="text/css" href="${cssURL}" />`}
  
          ${js && `<script src="${jsURL}">${atob("PC9zY3JpcHQ+")}`}
  
        </head>
  
        <body>
  
          ${html || ""}
  
        </body>
  
      </html>
  
    `;
  
    return getBlobURL(source, "text/html");
  }
  
  function pvw() {
    dom.iframe.code.doc = document.getElementById("iframe").contentWindow.document;
  
    dom.iframe.code.head = document.getElementById("iframe").contentWindow.document.querySelector("head");
  
    dom.iframe.code.head.innerHTML = '<style id="style"></style>';
  
    dom.iframe.code.style = dom.iframe.code.head.querySelector("style");
  
    //dom.iframe.code.body = document
      //.getElementById("preview-code")
      //.contentDocument.querySelector("body");
  }
  
  function upd() {
    pvw();
  
    var htm = cm.htm.getValue();
  
    var page = getPageURL(htm, '', '');
  
    console.log({htm, page})
  
    //dom.iframe.code.style.textContent = css;
    document.getElementById('iframe').src = page;
  }      
    </script>
  </body>
</html>
